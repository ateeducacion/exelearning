/**
 * Create an ABBR + Update ABBR or ACRONYM
 * Released under Attribution-ShareAlike 4.0 International License.
 * Author: Ignacio Gros (http://gros.es/) for http://exelearning.net/
 * License: http://creativecommons.org/licenses/by-sa/4.0/ 
 */

tinymce.PluginManager.add('abbr', function (editor) {
	function showDialog() {

		// Default values (empty)		
		let actualAbbr = "";
		let actualMeaning = "";

		// Update those values if we're in an ABBR or an ACRONYM
		var node = editor.selection.getNode();
		if (node.nodeName == "ABBR" || node.nodeName == "ACRONYM") {
			actualAbbr = node.innerHTML;
			actualMeaning = node.title;
		}

		// Open the dialog
		editor.windowManager.open({
			title: _('Acronym or abbreviation'),
			body: {
				type: 'panel',
				items: [
					{
						type: 'input',
						name: 'abbr',
						label: _('Abbreviation')
					},
					{
						type: 'input',
						name: 'meaning',
						label: _('Meaning')
					}
				]
			},
			buttons: [
				{
					type: 'cancel',
					name: 'cancel',
					text: 'Cancel'
				},
				{
					type: 'submit',
					name: 'save',
					text: 'Save',
					primary: true
				}
			],
			initialData: {
				abbr: actualAbbr,
				meaning: actualMeaning
			},
			onSubmit: function (api) {

				var abbr = api.getData().abbr;
				var meaning = api.getData().meaning;

				// Both fields are required
				if (abbr == "" || meaning == "") {
					editor.windowManager.alert(_('Please write the abbreviation and its meaning.'));
					return false;
				}

				var node = editor.selection.getNode();

				// Update the previous ABBR or ACRONYM
				if (node.nodeName == "ABBR" || node.nodeName == "ACRONYM") {

					if (node.nodeName == "ACRONYM" && editor.settings.schema == "html5") {

						// It's html5 and ACRONYM is being used, so we ask the user:
						editor.windowManager.confirm(
							_('The ACRONYM tag is not supported in HTML5.\n\nUse the ABBR tag instead?'),
							function (s) {
								if (s) {

									// Remove the ACRONYM and create an ABBR
									try {
										editor.dom.remove(node);
										editor.selection.setNode(tinymce.activeEditor.dom.create('abbr', { title: meaning }, abbr));
										editor.undoManager.add();
										editor.windowManager.close();
									} catch (e) {
										// IE 11 won't close the dialog (see https://github.com/exelearning/iteexe/issues/124)
										editor.windowManager.alert(_("Failed to save properties"));
									}

								} else {

									// Just update the ACRONYM
									editor.dom.setAttrib(node, "title", meaning);
									editor.dom.setHTML(node, abbr);
									editor.undoManager.add();
									editor.windowManager.close();

								}
							}
						);

					} else {

						// Update the node (ABBR or ACRONYM)
						editor.dom.setAttrib(node, "title", meaning);
						editor.dom.setHTML(node, abbr);
						editor.undoManager.add();
						editor.windowManager.close();

					}
				} else {

					// Create a new ABBR
					editor.selection.setNode(tinymce.activeEditor.dom.create('abbr', { title: meaning }, abbr));
					editor.undoManager.add();
					editor.windowManager.close();

				}

				return false;

			}
		});
	}

	editor.ui.registry.addMenuItem('abbr', {
		text: _('Acronym or abbreviation'),
		onAction: showDialog
	});

});