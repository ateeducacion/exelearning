/**
 * plugin.min.js
 *
 * Released under Attribution-ShareAlike 4.0 International License.
 * Author: Ignacio Gros (http://gros.es/) for http://exelearning.net/
 *
 * License: http://creativecommons.org/licenses/by-sa/4.0/
 */

/**
 * Insert ABC Music Notation Plugin for TinyMCE
 *
 * To be used with export/*.*
 *
	* acoustic_grand_piano-ogg.js, by Roberto Gordo Saez, under the CC BY license.
	* abcjs.js, by Paul Rosen and Gregory Dyke, under the GNU GPL v3 license.
	* midi.js, by Michael Deal, under the MIT License.
	* $exeABCmusic, by Ignacio Gros, under the CC BY-SA license.
 *
 */

tinymce.PluginManager.requireLangPack('abcmusic');

tinymce.PluginManager.add('abcmusic', function (editor, url) {

	let actualAnimation = false;
	let actualMidi = false;
	let actualHtmlSource = '';

	function getInitialData() {
		let data = {
			animation: actualAnimation,
			midi: actualMidi,
			htmlSource: actualHtmlSource
		}

		return data;
	}

	function setDefaultData() {
		actualAnimation = false;
		actualMidi = false;
		actualHtmlSource = '';

	}

	function setAttribsAndHide() {

		let divMain = $('div.tox-form').eq(0);

		let divCheckboxes = divMain.children().eq(0);

		let divAnimation = divCheckboxes.children().eq(0);
		let checkboxAnimation = divAnimation.children().eq(0);
		tinymce.DOM.setAttrib(checkboxAnimation, { 'id': 'animation' });
		divAnimation.hide();

		let checkboxMidi = divCheckboxes.children().eq(1).children().eq(0);
		tinymce.DOM.setAttrib(checkboxMidi, { 'id': 'midi' });

		let divHtmlSource = divMain.children().eq(2);
		let textareaHtmlSource = divHtmlSource.children().eq(0);
		tinymce.DOM.setStyles(textareaHtmlSource, { 'min-height': 200 });
		tinymce.DOM.setAttrib(textareaHtmlSource, { 'id': 'htmlSource' });

		let buttonPreview = divMain.children().eq(3).children().eq(0);
		tinymce.DOM.setStyle(buttonPreview, 'width', '100%');

		let labelAbcInstructions = divMain.children().eq(4).children().eq(0);
		tinymce.DOM.setAttrib(labelAbcInstructions, { 'id': 'abcInstructions' });

	}

	// Load the previous values (if needed)
	function getValues() {

		ABCmusicDialog.inPRE = false;
		ABCmusicDialog.currentPRE = "";

		// var abcInstructions = jQuery("#abcInstructions");
		// abcInstructions.html(abcInstructions.html().replace("eXeABC","<a href='http://abcnotation.com' target='_blank' style='text-decoration:underline;cursor:pointer'>abcnotation.com</a>"));			

		var n = editor.selection.getNode();

		if (n.nodeName == "PRE") {
			ABCmusicDialog.inPRE = true;
			ABCmusicDialog.currentPRE = n;
			if (jQuery(n).hasClass(ABCmusicDialog.cssClass + "-animated")) {
				// win.find("#animation").checked(true);
				actualAnimation = true;
			}
			if (jQuery(n).hasClass(ABCmusicDialog.cssClass + "-midi")) {
				// win.find("#midi").checked(true); 
				actualMidi = true;
			}
			// win.find('#htmlSource')[0].value(n.innerHTML);
			actualHtmlSource = n.innerHTML;
		}
	}

	function loadScript() {
		// setTimeout(function () {
		let iframe = editor.iframeElement;
		let head = iframe.contentDocument.getElementsByTagName('head')[0];
		let newScript = document.createElement("script");
		newScript.type = "text/javascript";
		newScript.href = url + '/export/exe_abcmusic.js';
		head.appendChild(newScript);
		// }, 1000);
	}

	ABCmusicDialog = {

		cssClass: "abc-music",

		jQueryPath: `${url}/../../../../../jquery/jquery.min.js`,

		abcjsPath: `${url}/export/exe_abcmusic.js`,

		abccssPath: `${url}/export/exe_abcmusic.css`,

		soundFontPath: `${url}/export/`,

		activateButton: function (node) {

			if (node.nodeName == "PRE" && node.className.indexOf(ABCmusicDialog.cssClass) == 0) return true;
			return false;

		},

		openDialog: function () {

			getValues();

			// Open the window
			win = editor.windowManager.open({
				title: tinymce.translate('ABC Music Notation'),
				// width: 500,
				body: {
					type: 'panel',
					items: [
						{
							type: 'panel',
							// layout: 'flex',
							// direction: 'row',
							// align: 'stretch',
							// padding: 5,
							// spacing: 10,
							items: [
								{
									type: 'checkbox',
									// id: 'animation', 
									name: 'animation',
									// checked: false, 
									label: tinymce.translate('Animation'),
									// hidden: true
								},
								{
									type: 'checkbox',
									// id: 'midi', 
									name: 'midi',
									// checked: false, 
									label: 'MIDI'
								}
							]
						},
						{
							type: 'label',
							label: tinymce.translate('Paste or type a valid ABC code:'),
							// forId: 'htmlSource'
							items: []
						},
						{
							type: 'textarea',
							// id: 'htmlSource',
							name: 'htmlSource',
							// minWidth: 500,
							// minHeight: 150,
							// multiline: true
						},
						{
							type: 'button',
							name: 'button',
							text: tinymce.translate("Preview"),
							// onclick : function(){
							// 	ABCmusicDialog.openPopup();
							// }
						},
						{
							// id: 'abcInstructions',
							type: 'label',
							label: tinymce.translate('Visit eXeABC for help, tunes, ABC software...'),
							items: []
						},
						{
							type: 'label',
							label: tinymce.translate('ePub export warning: This might not work in some ePub readers.'),
							items: []
						}
					]
				},
				buttons: [
					{
						type: 'cancel',
						name: 'cancel',
						text: 'Cancel'
					},
					{
						type: 'submit',
						name: 'save',
						text: 'Save',
						primary: true
					}
				],
				size: 'medium',
				initialData: getInitialData(),
				onChange: function (api, details) {
					switch (details.name) {
						case 'animation':
							actualAnimation = api.getData().animation;
							break;
						case 'midi':
							actualMidi = api.getData().midi;
							break;
					}
				},
				onAction: function (api, details) {
					switch (details.name) {
						case 'button':
							// ABCmusicDialog.openPopup();
							editor.windowManager.openUrl({
								title: tinymce.translate('ABC Music Notation'),
								url: url + "/abcmusic.html",
								// url: url + "/audio-full.html",
								width: 830,
								height: 650
							});

							let newWindowInterval = setInterval(() => {
								let dialogDoc = document.querySelector(".tox-dialog__body-iframe").querySelector("iframe").contentDocument;
								if(dialogDoc.querySelector(".abcjs-midi") !== null){
									clearInterval(newWindowInterval);
									if (!actualMidi) {
										dialogDoc.querySelector(".abcjs-audio").style.display = "none";
										dialogDoc.querySelector(".abcjs-midi").style.display = "none";
									}
								}
							}, 0);

							break;
					}
				},
				onSubmit: function (api) {
					// Insert content when the window form is submitted
					// var content = e.data.htmlSource;
					var content = api.getData().htmlSource;

					if (content == "") return "";

					var css = ABCmusicDialog.cssClass;

					var animation = actualAnimation;
					var animatedCSS = ABCmusicDialog.cssClass + "-animated"

					var midi = actualMidi;
					var midiCSS = ABCmusicDialog.cssClass + "-midi"

					if (!ABCmusicDialog.inPRE) {

						if (animation) css += " " + animatedCSS;
						if (midi) css += " " + midiCSS;
						content = '<pre class="' + css + '">' + content + '</pre><p>...</p>';
						editor.execCommand('mceInsertContent', false, content);

					} else {

						var n = jQuery(ABCmusicDialog.currentPRE);
						n.addClass(css);

						if (animation) n.addClass(animatedCSS);
						else n.removeClass(animatedCSS);

						if (midi) n.addClass(midiCSS);
						else n.removeClass(midiCSS);

						editor.dom.setHTML(ABCmusicDialog.currentPRE, content);

					}

					api.close();

				},
				onClose: function () {
					setDefaultData();
				}
			});

			setAttribsAndHide();

			let dialogWindow = $('div.tox-dialog').eq(0);
			tinymce.DOM.setStyle(dialogWindow, 'width', 600);

			// ABCmusicDialog.getValues();

			var abcInstructions = jQuery("#abcInstructions");
			abcInstructions.html(abcInstructions.html().replace("eXeABC", "<a href='http://abcnotation.com' target='_blank' style='text-decoration:underline;cursor:pointer'>abcnotation.com</a>"));

		}

	} // ABCmusicDialog	

	editor.ui.registry.addIcon('abcmusic', `
	<?xml version="1.0" encoding="utf-8"?>
	<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
	<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
	<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
		 width="24px" height="24px" viewBox="0 0 24 24" enable-background="new 0 0 24 24" xml:space="preserve">
	<desc>Created with Sketch.</desc>
	<g>
		<path fill-rule="evenodd" clip-rule="evenodd" d="M12.012,14.901c0-0.185,0-0.329,0-0.473c0-2.51,0-5.021,0.001-7.531
			c0-0.714,0.137-0.903,0.806-1.105c0.745-0.226,1.491-0.45,2.235-0.669c0.813-0.239,1.312,0.134,1.317,0.981
			c0.004,0.476,0.01,0.951-0.002,1.425c-0.014,0.569-0.227,0.842-0.774,1.003c-0.511,0.152-1.024,0.309-1.544,0.439
			c-0.245,0.062-0.318,0.178-0.316,0.431c0.011,2.291-0.053,4.583,0.026,6.871c0.057,1.674-0.968,2.389-2.163,2.659
			c-1.213,0.274-2.354,0.098-3.326-0.739c-0.864-0.743-0.867-1.897-0.008-2.642c0.959-0.83,2.08-0.997,3.289-0.753
			C11.693,14.826,11.832,14.86,12.012,14.901z"/>
	</g>
	</svg>`);
	editor.ui.registry.addToggleButton('abcmusic', {
		icon: 'abcmusic',
		tooltip: tinymce.translate('ABC Music Notation'),
		onAction: ABCmusicDialog.openDialog,
		onSetup: function (buttonApi) {
			var editorEventCallback = function (eventApi) {
				buttonApi.setActive(ABCmusicDialog.activateButton(eventApi.element));
			};
			editor.on('NodeChange', editorEventCallback);
			return function (buttonApi) {
				editor.off('NodeChange', editorEventCallback);
			}
		}
	});

	editor.ui.registry.addMenuItem('abcmusic', {
		// icon: 'image',
		text: tinymce.translate('ABC Music Notation'),
		onAction: ABCmusicDialog.openDialog,
		context: 'insert'
	});

	editor.on('init', function (e) {
		editor.dom.loadCSS(url + "/css/content.css");

		loadScript();
		// jQuery is required
		if (typeof (jQuery) != 'function') {
			alert(tinymce.translate('ABC Music Notation') + ": " + tinymce.translate('jQuery is required'));
			return false;
		}

		// i18n in CSS (type names in the right language)
		var d = editor.getDoc();
		var s = '<style type="text/css">';
		s += '.' + ABCmusicDialog.cssClass + ':before{content:"' + tinymce.translate('ABC Music') + '"}';
		s += '.' + ABCmusicDialog.cssClass + '-animated:before{content:"' + tinymce.translate('ABC Music') + ' + ' + tinymce.translate('Animation') + '"}';
		s += '.' + ABCmusicDialog.cssClass + '-midi:before{content:"' + tinymce.translate('ABC Music') + ' + MIDI"}';
		s += '.' + ABCmusicDialog.cssClass + '-animated.' + ABCmusicDialog.cssClass + '-midi:before{content:"' + tinymce.translate('ABC Music') + ' + ' + tinymce.translate('Animation') + ' + MIDI"}';
		s += '</style>';
		jQuery("HEAD", d).append(s);

	});

});