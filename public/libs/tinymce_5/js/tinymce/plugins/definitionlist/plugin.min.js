/**
 * plugin.min.js
 *
 * Released under Attribution-ShareAlike 4.0 International License.
 * Author: Ignacio Gros (http://gros.es/) for http://exelearning.net/
 *
 * License: http://creativecommons.org/licenses/by-sa/4.0/
 */

/**
 * TinyMCE plugin to create definition lists
 * Don't forget to add some styles to theme/site so the code has the same appearance everywhere (see eXe's base.css file)
 * You may also want to add some JavaScript effects (see eXe's common.js file)
 */
tinymce.PluginManager.add('definitionlist', function(editor, url) {
	
	function addListOrTerm() {
			var se = editor.selection;

			var term = "<dt>"+_('Term')+"</dt>\n<dd><p>"+_('Term definition')+"</p></dd>\n";
			
			// No selection and not in DL
			var p = editor.dom.getParent(se.getNode(), 'DL');
			if (se.isCollapsed() && !p) {
				editor.windowManager.confirm(
					_('A new Definition List will be created.\nTo add a new term, just place the cursor at the end of a definition and click again the Definition List button.\n'), 
					function(s){
						if (s) {
							var html = '<dl class="exe-dl">\n';
								html += term;
								html += "</dl><br />";
							tinyMCE.execCommand('mceInsertContent', false, html);
						}
					}
				);
			} else {
				
				var n = editor.dom.getNext(se.getNode(), 'DT');
				if (n) $(n).before($(term));
				else $(p).append($(term));
				
				p = editor.dom.getParent(se.getNode(), 'DL');
				var DTs = p.getElementsByTagName("DT");
				for (i=0;i<DTs.length;i++) {
					if(DTs[i].innerHTML==_('Term')) {
						editor.selection.setCursorLocation(DTs[i],1);
					}
				}
			}  		
	}
	
	editor.ui.registry.addIcon('definitionlist', `
	<?xml version="1.0" encoding="utf-8"?>
	<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
	<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
	<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
		 width="24px" height="24px" viewBox="0 0 24 24" enable-background="new 0 0 24 24" xml:space="preserve">
	<desc>Created with Sketch.</desc>
	<g>
		<rect x="4" y="5.03" fill-rule="evenodd" clip-rule="evenodd" width="8" height="1.958"/>
		<rect x="7.042" y="9.03" fill-rule="evenodd" clip-rule="evenodd" width="12.958" height="1.959"/>
		<rect x="4" y="13.011" fill-rule="evenodd" clip-rule="evenodd" width="8" height="1.959"/>
		<rect x="7.042" y="17.011" fill-rule="evenodd" clip-rule="evenodd" width="12.958" height="1.959"/>
	</g>
	</svg>`);
	editor.ui.registry.addButton('definitionlist', {
		tooltip: _('Definition List'),
		icon: "definitionlist",
		onAction: function() {
			addListOrTerm();
		}
	});
	
	editor.ui.registry.addMenuItem('definitionlist', {
		text: _('Definition List'),
		icon: "definitionlist",
		context: 'insert',
		onAction: function() {
			addListOrTerm();
		}
	});
	
	editor.on('init', function(e) {
		editor.dom.loadCSS(url + "/css/content.css");
	});	
	
});